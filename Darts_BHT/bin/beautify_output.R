## make pretty output for darts
## Zijun Zhang
## 12.13.2017
## revised 1.30.2018: change FPR<10% to FPR<5% to be consistent with RASL-seq analysis

my.version = list(
	version.string="Darts v0.1.0-20171213 and Darts_Snakemake_pipeline-beta",
	date="Dec.14, 2017",
	author="Zijun Zhang <zj.z@ucla.edu>"
)

read_rmats_annot = function(project, comparison) 
{
	fp = file.path(project, 'rmats', comparison, 'fromGTF.SE.txt')
	df = read.table(fp, header=T, stringsAsFactors=F)
	eid = paste(df$chr, df$strand, df$upstreamEE, df$exonStart_0base, df$exonEnd, df$downstreamES, sep=':')
	short_loci = paste(paste(df$chr, df$exonStart_0base, sep=':'), df$exonEnd, sep='-')
	short_gb_link = paste('https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&position=', short_loci, sep='')
	short_loci = paste('=HYPERLINK("', short_gb_link, '","', short_loci, '")', sep='')
	long_loci = paste(paste(df$chr, df$upstreamES, sep=':'), df$downstreamEE, sep='-')
	long_gb_link = paste('https://genome.ucsc.edu/cgi-bin/hgTracks?db=hg19&position=', long_loci, sep='')
	long_loci = paste('=HYPERLINK("', long_gb_link, '","', long_loci, '")', sep='')
	new.df = data.frame(ID=eid, geneSym=df$geneSymbol, geneID=df$GeneID, short_loci=short_loci, long_loci=long_loci)
	return(new.df)
}

read_darts_infer = function(project, comparison)
{
	fp1 = file.path(project, 'darts', comparison, 'darts_flat', 'Sp_out.txt')
	df1 = read.table(fp1, header=T, stringsAsFactors=F)
	df1 = df1[, c('ID', 'I1', 'S1', 'I2', 'S2', 'inc_len', 'skp_len', 'mu.mle', 'delta.mle', 'post_pr')]
	df1$psi2 = df1$mu.mle + df1$delta.mle
	
	fp2 = file.path(project, 'darts', comparison, 'darts_info', 'Sp_out.prior.txt')
	df2 = read.table(fp2, header=T, stringsAsFactors=F)
	df2 = df2[, c('ID', 'rho', 'post_pr')]
	df2 = df2[which(!is.na(df2$rho)),]
	
	dm = merge(df1, df2, by='ID', suffix=c('.flat', '.info'))
	return(dm)
}

beautiful_output = function(project, comparison, only.candidate=FALSE)
{
	# read required info
	annot = read_rmats_annot(project, comparison)
	darts.df = read_darts_infer(project, comparison)
	# prepare for output
	out.df = merge(annot, darts.df, by='ID')
	out.df = out.df[,c('ID', 'geneSym', 'mu.mle','psi2','delta.mle', 'rho', 'post_pr.flat', 'post_pr.info', 
		'I1', 'S1', 'I2', 'S2',
		'geneID', 'short_loci', 'long_loci')]
	out.df$mu.mle = round(out.df$mu.mle, 2)
	out.df$psi2 = round(out.df$psi2, 2)
	out.df$delta.mle = round(out.df$delta.mle, 3)
	out.df$rho = round(out.df$rho, 2)
	out.df$post_pr.flat = round(out.df$post_pr.flat, 3)
	out.df$post_pr.info = round(out.df$post_pr.info, 3)
	colnames(out.df) = c('ID', 'GeneSymbol', 'IncLevel1', 'IncLevel2', 'IncLevelDiff', 'Prior', 'Posterior_flat', 'Posterior_informative',
		'I1', 'S1', 'I2', 'S2',
		'geneID', 'cassetteExon', 'flankingExon')
	out.df = out.df[order(-out.df$Prior),]
	out.df = out.df[order(-out.df$Posterior_informative),]
	# measure prediction auc
	auc = PRROC::roc.curve( out.df$Prior[out.df$Posterior_flat>0.9], out.df$Prior[out.df$Posterior_flat<0.1] )
	aupr = PRROC::pr.curve( out.df$Prior[out.df$Posterior_flat>0.9], out.df$Prior[out.df$Posterior_flat<0.1] )
	#auc = list(auc=0.5)
	if(auc$auc>0.85) {
		msg = "highly recommend using Posterior_informative"
	} else if(auc$auc>0.75) {
		msg = "use Posterior_informative with care"
	} else
	{
		msg = "recommend using Posterior_flat due to inaccurate prediction"
	}
	# write output
	out.fn = file.path(project, 'darts', comparison, paste0('darts_out.',comparison, ifelse(only.candidate, '.candidate.txt','.txt') ) )
	cat('## Generated by', my.version$version.string,'\n', file=out.fn)
	cat('## auroc=', round(auc$auc,2), '; ', msg, '\n',  sep='', file=out.fn, append=T)
	if(only.candidate) {
		cat('## outputting only candidate\n', file=out.fn, append=T)
	}
	cat('##', my.version$author, '\n', file=out.fn, append=T)
	if(! only.candidate) cat('## \n', file=out.fn, append=T)
	if(only.candidate) {
		neg.ref = out.df$Prior[out.df$Posterior_flat<0.1]
		#fpr.point = quantile(neg.ref, p=0.9)
		fpr.point = quantile(neg.ref, p=0.95)   ## changed 1.30.2018: to be consistent with RASL-seq analysis
		candidate.idx = which( 
			out.df$Prior>fpr.point &
			out.df$Posterior_flat<0.9 &
			out.df$Posterior_flat>0.2 &
			abs(out.df$IncLevelDiff)>0.05
			)
		cat('outputting candidates; fpr.point=', fpr.point, '\n', sep='')
		suppressWarnings(write.table(out.df[candidate.idx, ], file=out.fn, quote=F, row.names=F, col.names=T, sep='\t', append=T))
	} else {
		suppressWarnings(write.table(out.df, file=out.fn, quote=F, row.names=F, col.names=T, sep='\t', append=T))
	}
}

argv = commandArgs(trailingOnly=T)
project = argv[1]
comparison = argv[2]
only.candidate = ifelse(length(argv)>2, as.logical(argv[3]), FALSE)
cat('processing "', comparison, '" in project ', project, '\n', sep='' )
beautiful_output(project, comparison, only.candidate)
